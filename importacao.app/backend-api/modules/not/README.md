# M√≥dulo de Notifica√ß√µes (NOT)

Sistema completo de notifica√ß√µes e alertas para o ERP NXT, fornecendo comunica√ß√£o em tempo real, alertas autom√°ticos e integra√ß√£o com todos os m√≥dulos do sistema.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Caracter√≠sticas](#caracter√≠sticas)
- [Arquitetura](#arquitetura)
- [Instala√ß√£o](#instala√ß√£o)
- [Configura√ß√£o](#configura√ß√£o)
- [API Reference](#api-reference)
- [Tipos de Notifica√ß√£o](#tipos-de-notifica√ß√£o)
- [Canais de Entrega](#canais-de-entrega)
- [Sistema de Alertas](#sistema-de-alertas)
- [Integra√ß√£o com M√≥dulos](#integra√ß√£o-com-m√≥dulos)
- [WebSocket/Socket.IO](#websocketsocketio)
- [Prefer√™ncias do Usu√°rio](#prefer√™ncias-do-usu√°rio)
- [Exemplos de Uso](#exemplos-de-uso)

## üéØ Vis√£o Geral

O m√≥dulo de notifica√ß√µes √© o centro de comunica√ß√£o do ERP NXT, respons√°vel por:

- **Notifica√ß√µes em tempo real** via WebSocket
- **Alertas autom√°ticos** baseados em regras de neg√≥cio
- **Notifica√ß√µes por email** com templates personaliz√°veis
- **Sistema de prefer√™ncias** personaliz√°vel por usu√°rio
- **Integra√ß√£o autom√°tica** com todos os m√≥dulos ERP
- **Hist√≥rico e arquivo** de notifica√ß√µes
- **Escalabilidade** com Redis para alta performance

## ‚ú® Caracter√≠sticas

### üîî Sistema de Notifica√ß√µes
- Notifica√ß√µes em tempo real via Socket.IO
- Suporte a m√∫ltiplos canais (in-app, email, SMS, push, webhook)
- Sistema de prioridades (baixa, m√©dia, alta, urgente)
- Expira√ß√£o autom√°tica de notifica√ß√µes
- Arquivamento e hist√≥rico completo

### üö® Sistema de Alertas
- Alertas autom√°ticos baseados em condi√ß√µes
- Monitoramento cont√≠nuo de:
  - N√≠veis de estoque
  - Vendas e pagamentos
  - Produ√ß√£o e qualidade
  - Indicadores financeiros
  - Status do sistema
  - Processos de importa√ß√£o/exporta√ß√£o

### üìß Notifica√ß√µes por Email
- Templates HTML responsivos
- Suporte a vari√°veis din√¢micas
- Sistema de retry autom√°tico
- Configura√ß√£o SMTP flex√≠vel

### ‚öôÔ∏è Prefer√™ncias Personaliz√°veis
- Configura√ß√£o por tipo de notifica√ß√£o
- Configura√ß√£o por canal de entrega
- Hor√°rios silenciosos
- Filtros por prioridade

### üîå Integra√ß√£o Autom√°tica
- Middleware transparente para m√≥dulos ERP
- Eventos autom√°ticos baseados em a√ß√µes
- API p√∫blica para integra√ß√£o customizada

## üèóÔ∏è Arquitetura

```
modules/not/
‚îú‚îÄ‚îÄ index.js                    # M√≥dulo principal
‚îú‚îÄ‚îÄ README.md                   # Documenta√ß√£o
‚îî‚îÄ‚îÄ ...

src/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ NotificationController.js    # Controller principal
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ NotificationService.js       # Servi√ßo de notifica√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ AlertService.js              # Servi√ßo de alertas
‚îÇ   ‚îú‚îÄ‚îÄ SocketService.js             # Servi√ßo WebSocket
‚îÇ   ‚îî‚îÄ‚îÄ EmailService.js              # Servi√ßo de email
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ Notification.js              # Modelo de notifica√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ NotificationPreference.js    # Modelo de prefer√™ncias
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îî‚îÄ‚îÄ notifications.js             # Middleware de integra√ß√£o
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ notifications.js             # Rotas da API
‚îî‚îÄ‚îÄ database/
    ‚îî‚îÄ‚îÄ migrations/
        ‚îî‚îÄ‚îÄ 004_create_notifications_system.js
```

## üöÄ Instala√ß√£o

### 1. Depend√™ncias

As depend√™ncias j√° est√£o inclu√≠das no `package.json` principal:

```json
{
  "socket.io": "^4.7.4",
  "ioredis": "^5.3.2",
  "nodemailer": "^6.9.7",
  "node-cron": "^3.0.3"
}
```

### 2. Executar Migrations

```bash
npm run db:migrate
```

### 3. Configurar Vari√°veis de Ambiente

```env
# Redis (para cache e filas)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# SMTP (para emails)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=seu-email@gmail.com
SMTP_PASS=sua-senha-app
SMTP_FROM=seu-email@gmail.com

# JWT (para autentica√ß√£o WebSocket)
JWT_SECRET=seu-jwt-secret

# Frontend (para links em emails)
FRONTEND_URL=http://localhost:3000
```

## ‚öôÔ∏è Configura√ß√£o

### Inicializa√ß√£o do M√≥dulo

```javascript
const notificationModule = require('./modules/not');
const express = require('express');
const http = require('http');

const app = express();
const server = http.createServer(app);

// Inicializar m√≥dulo com servidor HTTP para Socket.IO
await notificationModule.initialize(app, server);
```

### Configura√ß√£o de Alertas Autom√°ticos

Os alertas s√£o configurados automaticamente via migration, mas podem ser customizados:

```javascript
// Criar alerta personalizado
await knex('automated_alerts').insert({
  name: 'Estoque Cr√≠tico',
  description: 'Alerta quando estoque fica abaixo de 5%',
  module: 'est',
  alert_type: 'stock_critical',
  conditions: JSON.stringify({
    threshold_type: 'percentage',
    threshold_value: 5,
    comparison: 'less_than'
  }),
  recipients: JSON.stringify(['admin', 'manager']),
  frequency: 'immediate'
});
```

## üì° API Reference

### Notifica√ß√µes

#### Listar Notifica√ß√µes
```http
GET /api/notifications
```

**Query Parameters:**
- `page` (int): P√°gina da pagina√ß√£o
- `limit` (int): Itens por p√°gina
- `unread_only` (boolean): Apenas n√£o lidas
- `type` (string): Filtrar por tipo
- `priority` (string): Filtrar por prioridade
- `include_archived` (boolean): Incluir arquivadas

#### Criar Notifica√ß√£o
```http
POST /api/notifications
```

```json
{
  "user_ids": [1, 2, 3],
  "notification_type": "sales_alert",
  "title": "Novo Pedido",
  "message": "Pedido #123 foi criado",
  "priority": "medium",
  "channels": ["in_app", "email"],
  "data": {
    "order_id": 123,
    "customer": "Cliente ABC"
  }
}
```

#### Marcar como Lida
```http
PUT /api/notifications/{id}/read
```

#### Marcar Todas como Lidas
```http
PUT /api/notifications/mark-all-read
```

#### Arquivar Notifica√ß√£o
```http
PUT /api/notifications/{id}/archive
```

### Prefer√™ncias

#### Buscar Prefer√™ncias
```http
GET /api/notifications/preferences
```

#### Atualizar Prefer√™ncias
```http
PUT /api/notifications/preferences
```

```json
{
  "preferences": [
    {
      "notification_type_id": 1,
      "channel_id": 1,
      "is_enabled": true,
      "settings": {
        "immediate": true,
        "daily_digest": false
      }
    }
  ]
}
```

### Status e Sa√∫de

#### Informa√ß√µes do M√≥dulo
```http
GET /api/notifications/module/info
```

#### Status do M√≥dulo
```http
GET /api/notifications/module/status
```

#### Health Check
```http
GET /api/notifications/module/health
```

## üè∑Ô∏è Tipos de Notifica√ß√£o

| Tipo | Nome | Descri√ß√£o | √çcone |
|------|------|-----------|-------|
| `stock_alert` | Alerta de Estoque | Notifica√ß√µes sobre n√≠veis de estoque | warehouse |
| `sales_alert` | Alerta de Vendas | Notifica√ß√µes sobre vendas e pedidos | shopping-cart |
| `production_alert` | Alerta de Produ√ß√£o | Notifica√ß√µes sobre produ√ß√£o e qualidade | cogs |
| `financial_alert` | Alerta Financeiro | Notifica√ß√µes sobre pagamentos e or√ßamentos | dollar-sign |
| `system_alert` | Alerta do Sistema | Notifica√ß√µes sobre manuten√ß√£o e atualiza√ß√µes | server |
| `import_export_alert` | Alerta de Importa√ß√£o/Exporta√ß√£o | Notifica√ß√µes sobre processos de importa√ß√£o | exchange-alt |
| `general` | Geral | Notifica√ß√µes gerais do sistema | bell |

## üì¢ Canais de Entrega

### In-App (in_app)
- Notifica√ß√µes exibidas na interface
- WebSocket em tempo real
- Contador de n√£o lidas
- Hist√≥rico naveg√°vel

### Email (email)
- Templates HTML responsivos
- Suporte a vari√°veis din√¢micas
- Link de descadastro
- Retry autom√°tico

### SMS (sms) *
- Notifica√ß√µes por SMS
- Configura√ß√£o de hor√°rios silenciosos
- Apenas para alertas urgentes

### Push Notifications (push) *
- Notifica√ß√µes push para mobile
- Suporte a √≠cones e sons
- Agrupamento inteligente

### Webhook (webhook) *
- Integra√ß√£o com sistemas externos
- Payload customiz√°vel
- Retry com backoff exponencial

\* *Implementa√ß√£o futura*

## üö® Sistema de Alertas

### Alertas de Estoque

#### Estoque Baixo
```javascript
{
  "alert_type": "stock_low",
  "conditions": {
    "threshold_type": "percentage", // ou "quantity"
    "threshold_value": 10,
    "comparison": "less_than"
  }
}
```

#### Produto Sem Estoque
```javascript
{
  "alert_type": "out_of_stock",
  "conditions": {
    "threshold_value": 0,
    "comparison": "equal"
  }
}
```

### Alertas de Vendas

#### Novo Pedido
```javascript
{
  "alert_type": "new_order",
  "conditions": {
    "event": "order_created",
    "min_value": 1000 // Apenas pedidos acima de R$ 1.000
  }
}
```

### Alertas Financeiros

#### Pagamento Vencido
```javascript
{
  "alert_type": "payment_overdue",
  "conditions": {
    "days_overdue": 3
  },
  "frequency": "daily"
}
```

## üîå Integra√ß√£o com M√≥dulos

### Autom√°tica via Middleware

O sistema se integra automaticamente com todos os m√≥dulos atrav√©s de middleware:

```javascript
// Configura√ß√£o autom√°tica no m√≥dulo principal
app.use('/api/est/*', notificationMiddleware.stock);
app.use('/api/vnd/*', notificationMiddleware.sales);
app.use('/api/prd/*', notificationMiddleware.production);
```

### Manual via API P√∫blica

```javascript
const notificationAPI = notificationModule.getPublicAPI();

// Criar notifica√ß√£o
await notificationAPI.createNotification({
  user_ids: [1, 2],
  notification_type: 'custom_alert',
  title: 'Evento Personalizado',
  message: 'Algo importante aconteceu'
});

// Disparar alerta
await notificationAPI.triggerAlert('custom_alert', {
  data: 'custom data',
  recipients: ['admin']
});
```

## üì° WebSocket/Socket.IO

### Eventos do Cliente

#### Conex√£o
```javascript
const socket = io('http://localhost:3001', {
  auth: {
    token: 'jwt-token'
  }
});
```

#### Marcar Notifica√ß√£o como Lida
```javascript
socket.emit('mark_notification_read', {
  notificationId: 123
});
```

#### Subscrever Alertas
```javascript
socket.emit('subscribe_to_alerts', {
  alertTypes: ['stock_alert', 'sales_alert']
});
```

### Eventos do Servidor

#### Nova Notifica√ß√£o
```javascript
socket.on('new_notification', (data) => {
  console.log('Nova notifica√ß√£o:', data.notification);
  // Atualizar UI
});
```

#### Estat√≠sticas Atualizadas
```javascript
socket.on('notification_stats_updated', (stats) => {
  console.log('N√£o lidas:', stats.unread_count);
  // Atualizar contador
});
```

#### Alerta Disparado
```javascript
socket.on('alert_triggered', (data) => {
  console.log('Alerta:', data.alertType);
  // Exibir toast/modal
});
```

## üë§ Prefer√™ncias do Usu√°rio

### Estrutura das Prefer√™ncias

```javascript
{
  "notification_type_id": 1,
  "channel_id": 1,
  "is_enabled": true,
  "settings": {
    // Configura√ß√µes espec√≠ficas do canal
    "immediate": true,
    "daily_digest": false,
    "quiet_hours": {
      "start": "22:00",
      "end": "08:00"
    },
    "only_urgent": false
  }
}
```

### Configura√ß√µes Padr√£o

| Canal | Estoque | Vendas | Produ√ß√£o | Financeiro | Sistema |
|-------|---------|--------|----------|------------|---------|
| In-App | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Email | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| SMS | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚ùå |

## üí° Exemplos de Uso

### 1. Notifica√ß√£o Simples

```javascript
await notificationService.createNotification({
  user_id: 1,
  notification_type: 'general',
  title: 'Bem-vindo!',
  message: 'Seja bem-vindo ao sistema ERP NXT',
  priority: 'low',
  channels: ['in_app']
});
```

### 2. Alerta de Estoque Baixo

```javascript
// Disparado automaticamente pelo sistema
await alertService.triggerAlert('stock_low', {
  product_id: 123,
  current_stock: 5,
  min_stock: 10,
  recipients: ['manager', 'stock_supervisor']
});
```

### 3. Notifica√ß√£o de Novo Pedido

```javascript
// Via middleware autom√°tico ou manual
await notificationService.createNotification({
  user_ids: await getUsersByRole(['sales']),
  notification_type: 'sales_alert',
  title: 'Novo Pedido Recebido',
  message: `Pedido #${orderId} de ${customerName}`,
  priority: 'medium',
  channels: ['in_app'],
  action_url: `/vendas/pedidos/${orderId}`,
  action_label: 'Ver Pedido',
  data: {
    order_id: orderId,
    customer_name: customerName,
    order_value: orderValue
  }
});
```

### 4. Email com Template

```javascript
await emailService.sendNotification(
  'usuario@empresa.com',
  'Relat√≥rio de Estoque',
  'stock_report',
  {
    user_name: 'Jo√£o Silva',
    report_date: new Date(),
    low_stock_count: 5,
    out_of_stock_count: 2
  }
);
```

### 5. Configurar Prefer√™ncias

```javascript
await notificationController.updatePreferences(req, res);
// Corpo da requisi√ß√£o:
{
  "preferences": [
    {
      "notification_type_id": 1, // stock_alert
      "channel_id": 1, // in_app
      "is_enabled": true,
      "settings": {
        "show_desktop_notifications": true
      }
    },
    {
      "notification_type_id": 1, // stock_alert
      "channel_id": 2, // email
      "is_enabled": true,
      "settings": {
        "immediate": true,
        "daily_digest": false
      }
    }
  ]
}
```

## üîß Manuten√ß√£o

### Limpeza Autom√°tica

O sistema executa limpezas autom√°ticas:

- **Notifica√ß√µes expiradas**: Removidas automaticamente
- **Logs de alerta antigos**: Removidos ap√≥s 30 dias
- **Cache Redis**: Expira√ß√£o autom√°tica configurada

### Monitoramento

```javascript
// Verificar sa√∫de do sistema
const health = await notificationModule.checkHealth();

// Obter estat√≠sticas
const stats = await notificationModule.getModuleStats();

// Verificar usu√°rios conectados
const connectedUsers = notificationModule.getPublicAPI().getConnectedUsers();
```

## üìä M√©tricas e Logs

O sistema registra automaticamente:

- Total de notifica√ß√µes enviadas
- Taxa de entrega por canal
- Alertas disparados vs. falsos positivos
- Usu√°rios conectados em tempo real
- Performance de queries
- Erros e tentativas de retry

## ü§ù Contribui√ß√£o

Para contribuir com o m√≥dulo de notifica√ß√µes:

1. Mantenha a compatibilidade com a API existente
2. Adicione testes para novos features
3. Documente novos tipos de alerta
4. Considere performance e escalabilidade
5. Mantenha logs detalhados para debugging

## üìù Changelog

### v1.0.0
- ‚úÖ Sistema completo de notifica√ß√µes
- ‚úÖ Alertas autom√°ticos
- ‚úÖ WebSocket/Socket.IO
- ‚úÖ Notifica√ß√µes por email
- ‚úÖ Sistema de prefer√™ncias
- ‚úÖ Integra√ß√£o com m√≥dulos ERP
- ‚úÖ API completa REST
- ‚úÖ Middleware autom√°tico

### Pr√≥ximas Vers√µes
- üì± Push notifications mobile
- üìû Notifica√ß√µes por SMS
- üîó Sistema de webhooks
- üìä Dashboard de m√©tricas
- ü§ñ IA para alertas inteligentes

---

**Desenvolvido por NXT Ind√∫stria e Com√©rcio Ltda**  
Sistema ERP NXT - M√≥dulo de Notifica√ß√µes v1.0.0